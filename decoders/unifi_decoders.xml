<!-- Wazuh Decoders for Unifi Network Devices -->
<!-- Supports: Cloud Gateway Max, Switch Lite 8 PoE, U7 Lite Access Point -->

<decoder name="unifi">
  <program_name>^unifi</program_name>
</decoder>

<decoder name="unifi-gateway">
  <parent>unifi</parent>
  <prematch>^gateway|^UCG-Max|^cloudgateway</prematch>
</decoder>

<decoder name="unifi-switch">
  <parent>unifi</parent>
  <prematch>^switch|^USW</prematch>
</decoder>

<decoder name="unifi-ap">
  <parent>unifi</parent>
  <prematch>^ap|^U7|^accesspoint</prematch>
</decoder>

<!-- Gateway Authentication Events -->
<decoder name="unifi-gateway-auth">
  <parent>unifi-gateway</parent>
  <regex offset="after_parent">(\S+)\s+(\S+)\s+user\s+(\S+)\s+(login|logout|authentication)</regex>
  <order>srcip,dstip,user,action</order>
</decoder>

<!-- Gateway Firewall Events -->
<decoder name="unifi-gateway-firewall">
  <parent>unifi-gateway</parent>
  <regex offset="after_parent">firewall\s+(\w+)\s+SRC=(\S+)\s+DST=(\S+)\s+.*PROTO=(\w+)</regex>
  <order>action,srcip,dstip,protocol</order>
</decoder>

<decoder name="unifi-gateway-firewall-port">
  <parent>unifi-gateway-firewall</parent>
  <regex>SPT=(\d+)\s+DPT=(\d+)</regex>
  <order>srcport,dstport</order>
</decoder>

<!-- Gateway IDS/IPS Events -->
<decoder name="unifi-gateway-ids">
  <parent>unifi-gateway</parent>
  <regex offset="after_parent">IDS:\s+(\w+)\s+\[(\d+):(\d+):(\d+)\]\s+(.*?)\s+SRC=(\S+)\s+DST=(\S+)</regex>
  <order>action,id1,id2,id3,signature,srcip,dstip</order>
</decoder>

<!-- Gateway VPN Events -->
<decoder name="unifi-gateway-vpn">
  <parent>unifi-gateway</parent>
  <regex offset="after_parent">VPN:\s+(\w+)\s+user\s+(\S+)\s+from\s+(\S+)</regex>
  <order>action,user,srcip</order>
</decoder>

<!-- Gateway DHCP Events -->
<decoder name="unifi-gateway-dhcp">
  <parent>unifi-gateway</parent>
  <regex offset="after_parent">DHCP(\w+)\s+.*?on\s+(\S+)\s+to\s+(\S+)</regex>
  <order>action,mac,srcip</order>
</decoder>

<!-- Switch Port Events -->
<decoder name="unifi-switch-port">
  <parent>unifi-switch</parent>
  <regex offset="after_parent">port\s+(\d+)\s+(up|down|enabled|disabled)</regex>
  <order>port,status</order>
</decoder>

<!-- Switch PoE Events -->
<decoder name="unifi-switch-poe">
  <parent>unifi-switch</parent>
  <regex offset="after_parent">PoE\s+port\s+(\d+)\s+(enabled|disabled|overload|fault|delivering|searching)</regex>
  <order>port,status</order>
</decoder>

<!-- Switch MAC Learning -->
<decoder name="unifi-switch-mac">
  <parent>unifi-switch</parent>
  <regex offset="after_parent">MAC\s+(\S+)\s+(learned|aged|moved)\s+.*?port\s+(\d+)</regex>
  <order>mac,action,port</order>
</decoder>

<!-- Switch STP Events -->
<decoder name="unifi-switch-stp">
  <parent>unifi-switch</parent>
  <regex offset="after_parent">STP:\s+port\s+(\d+)\s+(\w+)</regex>
  <order>port,status</order>
</decoder>

<!-- Access Point Client Events -->
<decoder name="unifi-ap-client">
  <parent>unifi-ap</parent>
  <regex offset="after_parent">STA\s+(\S+)\s+(connected|disconnected|associated|disassociated)\s+.*?SSID:\s+(\S+)</regex>
  <order>mac,action,ssid</order>
</decoder>

<decoder name="unifi-ap-client-auth">
  <parent>unifi-ap</parent>
  <regex offset="after_parent">STA\s+(\S+)\s+authentication\s+(success|failed|timeout)\s+.*?SSID:\s+(\S+)</regex>
  <order>mac,status,ssid</order>
</decoder>

<!-- Access Point Radio Events -->
<decoder name="unifi-ap-radio">
  <parent>unifi-ap</parent>
  <regex offset="after_parent">radio\s+(2G|5G|6G)\s+(up|down|channel\s+changed\s+to\s+(\d+))</regex>
  <order>band,status,channel</order>
</decoder>

<!-- Access Point Rogue AP Detection -->
<decoder name="unifi-ap-rogue">
  <parent>unifi-ap</parent>
  <regex offset="after_parent">Rogue\s+AP\s+detected:\s+BSSID\s+(\S+)\s+SSID:\s+(\S+)\s+Channel:\s+(\d+)</regex>
  <order>mac,ssid,channel</order>
</decoder>

<!-- Generic Unifi System Events -->
<decoder name="unifi-system">
  <parent>unifi</parent>
  <regex>system:\s+(startup|shutdown|reboot|upgrade|config\s+changed)</regex>
  <order>action</order>
</decoder>

<!-- Unifi Threat Detection -->
<decoder name="unifi-threat">
  <parent>unifi</parent>
  <regex>threat\s+detected:\s+(\w+)\s+from\s+(\S+)\s+to\s+(\S+)</regex>
  <order>threat_type,srcip,dstip</order>
</decoder>

<!-- Unifi DPI Events -->
<decoder name="unifi-dpi">
  <parent>unifi</parent>
  <regex>DPI:\s+(\S+)\s+SRC=(\S+)\s+DST=(\S+)\s+APP=(\S+)</regex>
  <order>action,srcip,dstip,application</order>
</decoder>
